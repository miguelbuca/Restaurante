<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./src/css/main.css">
    <link rel="stylesheet" href="./src/css/formBs.min.css">
    <link rel="stylesheet" href="./src/components/swiper/swiper.min.css">
    <link rel="stylesheet" href="./assets/font/fontawesome-free/css/all.css">
    <link rel="shortcut icon" href="./assets/img/Cloche_food_kitchen_restaurant_icon-512.png" type="image/x-icon">
    <title>Restaurante</title>
    <script src="js.js"></script>
</head>
<body>
   <aside>
       <div class="logo-box">
           <span>
               <img src="./assets/img/Cloche_food_kitchen_restaurant_icon-512.png" alt="">
           </span>
           <strong>Restaurante</strong>
       </div>
       <div>
           <!-- Swiper -->
           <div class="swiper-container">
               <div class="swiper-wrapper">
                   <div class="swiper-slide" product="Hamburger Onion Ring">
                       <img src="./assets/img/FAVPNG_whopper-chicken-sandwich-crispy-fried-chicken-hamburger-onion-ring_fpmMgHst.png" alt="">
                   </div>
                   <div class="swiper-slide" product="Hamburger Onion Ring">
                       <img src="./assets/img/FAVPNG_whopper-chicken-sandwich-crispy-fried-chicken-hamburger-onion-ring_fpmMgHst.png" alt="">
                   </div>
               </div>
               <!-- Add Pagination -->
               <div class="swiper-pagination"></div>
           </div>
       </div>
       <div class="navigation">
           <div class="navigation-img-container">
               <img src="./assets/img/avatar.png" alt="user-img">
           </div>
           <div>
               <ul>
                   <li><a href="#">Minha conta</a></li>
                   <li><a href="#">Histórico</a></li>
                   <li><a href="src/views/settings/login/">Área reservada</a></li>
               </ul>
               <div class="navigation-list-footer">
                   <button class="sign-out-button">
                       Terminar sessão<i class="fas fa-sign-out-alt"></i>
                   </button>
               </div>
           </div>
       </div>
   </aside>
   <main>
       <header>
           <nav>
                <div class="logo-box">
                    <span>
                        <img src="./assets/img/Cloche_food_kitchen_restaurant_icon-512.png" alt="">
                    </span>
                    <strong>Restaurante</strong>
                </div>
               <ul>
                    <li><a isTarget="false" href="#">Home</a></li>
                    <li><a isTarget="false" href="#Cardapio"><i style="margin-right: 1rem;" class="fas fa-cookie"></i>Cardápio</a></li>
                    <li><a isTarget="false" href="#Localizacao">Localização</a></li>
                    <li><a isTarget="false" href="#Sobre">Sobre</a></li>
               </ul>
               <div>
                   <i id="cart" style="position: relative;" class="fas fa-shopping-cart">
                       <span class="n-shopping-cart" id="cartValue"></span>
                   </i>
                   <i class="fas fa-bars" id="side_nav"></i>
               </div>
           </nav>
       </header>
       <section>
           <div id="#">
               <h4>Você está com fome?</h4>
               <h1>Não espere!</h1>
               <label>Comece a ordenar a comida agora</label>
               <button id="toggle" class="sign-out-button">
                   Cadastra-te<i class="fas fa-arrow-right"></i>
               </button>
           </div>
           <div class="cardapio" id="Cardapio">
                <div>
                    <button active="true">Todos</button>
                    <button>Matabicho</button>
                    <button>Almoço</button>
                    <button>Jantar</button>
                </div>
                <div id="CardapioList">
                </div>
           </div>
           <div class="localizacao" id="Localizacao">
               <div>
                   <div>
                       <strong>Horário</strong>
                   </div>
                   <div class="clock-area">
                       <div>
                            <i class="fas fa-clock"></i>
                       </div>
                       <div>
                            <span>
                                <strong>Segunda à Sexta</strong>
                                <small>7:30 - 22:00 horas</small>
                            </span>
                            <span>
                                <strong>Sábado</strong>
                                <small>7:30 - 22:00 horas</small>
                            </span>
                            <span>
                                <strong>Domingo</strong>
                                <small>Fechado</small>
                            </span>
                       </div>
                   </div>
               </div>
               <div>
                    <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d15763.882113774953!2d13.2170528!3d-8.9748589!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0xc1b45c57d9661cff!2sUrbaniza%C3%A7%C3%A3o%20Boa%20Vida!5e0!3m2!1spt-PT!2sao!4v1600244411495!5m2!1spt-PT!2sao" height="450" style="width: 100%;" frameborder="0" style="border:0;" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>
               </div>
           </div>
       </section>
       <footer id="Sobre">
           <div>
            <div>
                <div>
                    <strong>Restaurante</strong>
                </div>
                <div class="about">
                    Habilite esta opção para nos permitir entre contacto com você apartir da sua conta email o contacto pessoal, para te
                    manter informado das nossas actualizações e gerar maior interação com a nossa página ou aplicação
                </div>
            </div>
            <div class="input-area">
                <div>
                    <strong>Entrar em contacto</strong>
                </div>
                <form action="post">
                    <div class='form__group'>
                        <textarea class='form__input' name='mensagem' id='mensagem' placeholder='Mensagem' required></textarea>
                        <label class='form__label'>Mensagem</label>
                    </div>
                    <div class='form__group'>
                        <input type='email' class='form__input' name='email' id='email' placeholder='Email' required />
                        <label class='form__label'>Email</label>
                    </div>
                    <div class='form__group'>
                        <button class="btn-send">Enviar</button>
                    </div>
                </form>
            </div>
           </div>
           <div>
               <small>Restaurante &copy; todos os seus direitos reservados</small>
           </div>
       </footer>
       <div class="popup"></div>
       <div class="popup_content"></div>
   </main>
   <script src="./src/components/swiper/swiper.min.js"></script>
   <script src="./api/index.js"></script>
   <script>

        let api = new Api();

        let shoppingCart = {}


    loadFood = (categoriaName) =>{
        api.send({
            table: "refeicao",
            method: "all",
            data: {
            allPage: true
            }
        }).then(({ data }) => {
            let result = ``
            data?.filter(({ categoria })=>categoria === categoriaName.toLowerCase() || categoriaName.toLowerCase() === 'Todos'.toLowerCase()).map(produto=>{
                let { id, nome, preco , foto, descricao } = produto
                result += `
                        <div class="food-card" onclick="mostrarRefeicao('${id}','${nome}','${preco}','${foto}','${descricao}')">
                        <div>
                            <img src="${api.filePath()}${foto}" alt="${foto}">
                        </div>
                        <div>
                            <div>
                                <h4>${nome}</h4>
                                <label>${preco} Akz</label>
                            </div>
                            <div>
                                <span>
                                    <i class="fas fa-eye"></i>
                                </span>
                                <span>18 views</span>
                            </div>
                        </div>
                    </div>
                `
            })

            CardapioList.innerHTML = result
        })
    }

    loadFood('Todos')
        

        
    var POPUP = document.querySelector('.popup');
    var POPUP_CONTENT = document.querySelector('.popup_content');

    let isOpen = false
    toggle.addEventListener('click',()=>{
        toggleModal(`
                <div class="modal_container">
                    <div class="modal_container--header"><strong style="text-transform: uppercase;">Cadastra-te</strong><button onclick="closeAll()"
                            class="popup_close">&times;</button>
                    </div>
                    <div id="form1" style="display: flex; flex-direction: row">
                        <div class="form_container">
                           <div class="upload-image-container">
            
                            <img src="./assets/img/avatar.png" id="img__profile" onclick="foto.click()"> 
                            <input id="foto" id="foto" onChange="changeFile()" img="imgPessoa" type="file" name="foto" accept="image" hidden>
                        </div>
                        </div>
                        <div>
                        <div class="product-from">
                            <div>
                                <div class='form__group'>
                                    <span></span>
                                    <input type='text' class='form__input' name='nomePessoa' id='nome'
                                        placeholder='Nome' required />
                                    <label class='form__label'>Nome</label>
                                </div>
                                <div class='form__group'>
                                    <input type='text' class='form__input' name='bi' id='bi' placeholder='Nº BI'
                                        required />
                                    <label class='form__label'>BI</label>
                                </div>
                            </div>
                            <div>
                                <div class='form__group'>
                                    <select title='Estado civil' id="estadocivil" class='form__input'>
                                        <optgroup label="Estado civil">
                                            <option value="Solteiro">Solteiro</option>
                                            <option value="Casado">Casado</option>
                                            <option value="Divorciado">Divorciado</option>
                                            <option value="Outro">Outro</option>
                                        </optgroup>
                                    </select>
                                    <label class='form__label'>Estado civil</label>
                                </div>
                                <div class='form__group'>
                                    <input type='date' title="Aniversário" class='form__input' name='date' id='aniversario' required />
                                    <label class='form__label'>Aniversário</label>
                                </div>
                            </div>
                            <div>
                                <div class='form__group'>
                                    <input type='text' class='form__input' name='endereço' id='endereco'
                                        placeholder='Endereço' required />
                                    <label class='form__label'>Endereço</label>
                                </div>
                                <div class='form__group'>
                                    <select title='Sexo' id="sexo" class='form__input'>
                                        <optgroup label="sexo">
                                            <option value="Masculino">Masculino</option>
                                            <option value="Feminino">Feminino</option>
                                        </optgroup>
                                    </select>
                                    <label class='form__label'>Sexo</label>
                                </div>
                            </div>
                            <div>
                                <div class='form__group'>
                                    <input type='text' class='form__input' name='telefone1' id='telefone1'
                                        placeholder='Telefone 1' required />
                                    <label class='form__label'>Telefone 1</label>
                                </div>
                                <div class='form__group'>
                                    <input type='text' class='form__input' name='telefone2' id='telefone2'
                                        placeholder='Telefone 2' required />
                                    <label class='form__label'>Telefone 2</el>
                                </div>
                            </div>
                             <div>
                                 <div class='form__group'>
                                     <input type='text' class='form__input' name='nomeUsuario' id='nomeUsuario'
                                         placeholder='Nome de usuário' required />
                                     <label class='form__label'>Nome</label>
                                 </div>
                                 <div class='form__group'>
                                     <input type='password' class='form__input' name='senha' id='senha'
                                         placeholder='senha' required />
                                     <label class='form__label'>Senha</label>
                                 </div>
                             </div>
                              <div>
                                  <div class='form__group'>
                                      <input type='email' class='form__input' name='email' id='email1'
                                          placeholder='Email' required />
                                      <label class='form__label'>Email de recuperaçao</label>
                                  </div>
                                  <div class='form__group'>
                                  </div>
                              </div>
                        </div>
                        <div class="add-buttons-conatiner" style="display: flex; justify-content: flex-end;">
                            <button class="btn-add-item" onClick="adicionarCliente('pessoa',{
            nome: nome.value,
            bi: bi.value,
            estadocivil: estadocivil.value,
            foto: foto.files[0],
            aniversario: aniversario.value,
            endereco: endereco.value,
            sexo: sexo.value,
            telefone1: telefone1.value,
            telefone2: telefone2.value
         },{
             nomeUsuario: nomeUsuario.value,
             senha: senha.value,
             email1: email1.value,
             acesso: 'cliente'
         })">Adicionar</button>
                            <button onClick="limparForm()" class="btn-clear-item">Limpar</button>
                        </div>
                        </div>

                    </div>
                    </div>
                </div>
        `)
    })


    updateCart = () => {
        cartValue.innerText = Object.keys(shoppingCart).length
        cartValue.style.display = Object.keys(shoppingCart).length ? 'flex' : 'none'
    }

    function adicionarCarrinho(id,nome, preco , foto, descricao){

        let qtd = shoppingCart[id] ? shoppingCart[id]?.quantidade : 0

        shoppingCart[id] = {data: {id,nome, preco , foto, descricao},quantidade: ++qtd}

        updateCart();
    }

    mostrarRefeicao = async (id,nome, preco , foto, descricao) => {
        toggleModal(`
            <div class="modal_container food-show">
                <div class="modal_container--header"><button onclick="closeAll()"
                    class="popup_close">&times;</button>
                </div>
                <div>
                    <div>
                        <img id="imgPessoa1" src="${api.filePath()}${foto}" alt="${nome}">
                    </div>
                    <div>
                        <h3>${nome}</h3>
                        <h1>${preco} Akz</h1>
                        <p>${descricao}</p>
                        <div>
                            <button class="sign-out-button" onclick="adicionarCarrinho(${id},'${nome}',${preco},'${foto}','${descricao}')">
                                    adicionar
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                        </div>
                    </div>
                </div>
            </div>
        `)
    
    }


    function validar(values){
        //"string"
       let vetKeys =  Object.keys(values);
    let sms = "Campos Obrigatório: "
       let travou = false;
       for(i=0; i<vetKeys.length; i++){
           const key = vetKeys[i];
           const valor = values[key]
      
          if( typeof valor === "string")
           if(key !== "telefone2" && valor?.trim()==""){
               const el = document.querySelector("#"+key);               
               console.log(key+"=>",el)

               if(el){
                    let place = el.placeholder;
                    place = place.trim() !== "" ? place : el.getAttribute("title")
                    sms += " "+place+" "+( i+2< vetKeys.length? ", ":"" );
               }else{
                   console.log(key)
                   console.log(el)
               }
               travou = true
           }
       }

       if(travou){
           alert(sms)       }
           return travou
    }

    function changeFile(){
        const img= document.querySelector("#img__profile");
        img.src = URL.createObjectURL(foto.files[0])
    }
    function limparForm(){
        img__profile.setAttribute("src","./assets/img/avatar.png");
        foto.files= new DataTransfer().files;
        let vetEl = [...form1.querySelectorAll("input")];
        vetEl.forEach(e=>e.value=null)
        vetEl = [...form1.querySelectorAll("select")];
        vetEl.forEach(e=>e.selectedIndex=0)
        
      
    }

    adicionarCliente = async (table,values,userValue) =>{

        if(values.foto === undefined){
            delete values.foto;
        }

       if(validar(values)) return;
       if(validar(userValue)) return;
      
        let pessoa = await api.send({
            table: table,
            method: "add",
            data: values
        });

        let { data, inserted_id, status } = pessoa

        if((data === status) === true){
            userValue['pessoaId'] = inserted_id
            userValue['nome'] = userValue.nomeUsuario;
            userValue['email']=userValue.email1;
            delete userValue.nomeUsuario;
            delete userValue.email1;
            let { data } = await api.send({
                table: 'usuario',
                method: "add",
                data: userValue
            })

            if(data){
                alert('cadastrado com sucesso');
                closeAll()
            }else{
                'houve uma falha ao cadastar'
            }
            console.log(data);
        }
    }

    removeItem = (index) =>{

        //Gole.log(Object.keys(shoppingCart).indexOf(index.toString()))


        Object.keys(shoppingCart).splice(Object.keys(shoppingCart).indexOf(index.toString()),1)

    }

    enviarReserva = async (total,anexo) => {

        let data = [...new Date().toLocaleDateString().split('/')]

        let values = { 
            dataReserva: `${data[2]}-${data[1]}-${data[0]}`, 
            usuarioId: 2, 
            estado: 0,
            total,
            anexo
        }

            let { status, inserted_id } = await api.send({
                table: 'reserva',
                method: "add",
                data: values
            })

            if(status){
                Object.keys(shoppingCart).forEach(async key =>{
                    let { id } = shoppingCart[key]?.data

                     let res = await api.send({
                        table: 'listareserva',
                        method: "add",
                        data: {
                            reservaId: inserted_id,
                            refeicaoId: id
                        }
                    })
                })
            }
    }


    cart.addEventListener('click', async () =>{

        if(Object.keys(shoppingCart).length>0){

            let list = ``
            let totalPagar = 0

             

            Object.keys(shoppingCart).map((key,index)=>{
                let {data: { nome, preco, foto } , quantidade} = shoppingCart[key]

                totalPagar += preco*quantidade

                list += `<li>
                        <div>
                            <div>
                                <img src="${api.filePath()}${foto}" />
                            </div>
                            <div>
                                <span>${nome}</span>
                                <span>
                                    ${quantidade}
                                </span>
                            </div>
                            <div>
                                <span><i onclick="removeItem(${key})" class="fas fa-times"></i></span>
                            </div>
                        </div>
                    </li>`

            })

            toggleModal(`
            <div class="modal_container shopping-cart-show">
                <div class="modal_container--header"><button onclick="closeAll()"
                        class="popup_close">&times;</button>
                </div>
                <div>
                    <div>
                        <h3 style="color: #ccc;">Lista de reserva</h3>
                        <div style="position: relative;flex: 1">
                            <ul class="reserva-list">
                                ${list}
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h3>Total</h3>
                        <h1>${totalPagar} Akz</h1>
                        <p>
                            Anexar comprovativo
                            <input type="file" id="anexoComprovativo"/>
                        </p>
                        <div>
                            <button class="sign-out-button"
                                onclick="enviarReserva('${totalPagar}',anexoComprovativo.files[0])">
                                    Enviar reserva
                                    <i class="fab fa-telegram-plane"></i>
                                </button>
                        </div>
                    </div>
                </div>
            </div>
        `)
        
        }

    })

    let [ navigation, state ] = [ document.querySelector('.navigation'), true]


    let aside = document.querySelector('body>*:first-child')

    let ulMobileMenu = document.querySelector('header>nav>ul')

    side_nav.addEventListener('click',()=>{
        if(!state){
            navigation.style.left= '-110%'
            state = true
            side_nav.setAttribute('class','fas fa-bars')
            aside.style.zIndex = '0'
            ulMobileMenu.style.left= '-110%'
        }else{
            navigation.style.left= '0'
            state = false
            side_nav.setAttribute('class','fas fa-times')
            aside.style.zIndex = '1'
            ulMobileMenu.style.left= '50%'
        }
    })

    toggleModal = (container) =>{

         /*** Set transparent black background **/
        POPUP.style.opacity = 1
        POPUP.style.visibility = 'visible'

        POPUP_CONTENT.innerHTML = container

        /*** Show modal container **/        
        POPUP_CONTENT.style.opacity = 1
        POPUP_CONTENT.style.transform = 'translate(-50%, -50%) scale(1)'
    }

    closeAll = () =>{
        POPUP_CONTENT.style.opacity = 0
        POPUP_CONTENT.style.transform = 'translate(-50%, -50%) scale(.25)'
        POPUP.style.opacity = 0
        POPUP.style.visibility = 'hidden'
        isOpen = false;
    }

       var swiper = new Swiper('.swiper-container', {
            pagination: '.swiper-pagination',
            nextButton: '.swiper-button-next',
            prevButton: '.swiper-button-prev',
            paginationClickable: true,
            spaceBetween: 30,
            centeredSlides: true,
            autoplay: 2500,
            autoplayDisableOnInteraction: false
       }); // inicialização do componente swiper

       let navItem = document.querySelectorAll('header>nav>ul>li>a')

       let navItemFood = document.querySelectorAll('.cardapio>div:first-child button')

       
       clearTarget = () =>navItem.forEach(element=>element.setAttribute('isTarget',false)) // desativa a isTargt dos links

       clearTargetFood = () =>navItemFood.forEach(element=>element.setAttribute('active',false)) // desativa a active dos tabFood
       
       navItem.forEach(e=>
            e.addEventListener('click',()=>{
                clearTarget()
                e.setAttribute('isTarget',true)
            })
       ) // faz a activação dos eventos onclick nos link 

        navItemFood.forEach(e=>
            e.addEventListener('click',()=>{
                clearTargetFood()

                loadFood(e.innerText)
                
                e.setAttribute('active',true)
            })
       ) // faz a activação dos eventos onclick nos linck 

       
       clearTarget(); 

        window.location.hash === '#Cardapio' ? (
            navItem[1]?.setAttribute('isTarget',true)) :
        window.location.hash === '#Localizacao' ? (
            navItem[2]?.setAttribute('isTarget',true)) :
        window.location.hash === '#Sobre' ? (
            navItem[3]?.setAttribute('isTarget',true)) : 
        (navItem[0]?.setAttribute('isTarget',true)) //Faz a activação do currente target logo de início

    </script>
</body>
</html>